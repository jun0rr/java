
{disecMicro}

# Insere registro na tabela de log do micro serviço
[insertLog]
  INSERT INTO disecMicro.log (
    ip, url, context, uri, cd_usu, uor_depe, uor_eqp, autd
  ) VALUES (
    ?, ?, ?, ?, ?, ?, ?, ?
  );

# Procura a query no banco de dados do micro serviço
[findQuery]
  SELECT `sql` FROM disecMicro.sqls
  WHERE `group` = ? AND `name` = ? AND enabled = 1;

# Busca informações para o micro serviço de upload de arquivos
[findUpload]
  SELECT * FROM disecMicro.upload 
  WHERE `aplic` = ? AND enabled = 1;


{intranet}

# Busca os perfis de acesso da aplicação
[selectPflAcss]
  SELECT PA.cd_pfl_acss, 
    PA.nm_pfl_acss, 
    PA.cd_tp_pfl_acss, 
    GP.cd_grp_acss,
    PA.sql_val
  FROM acss.pfl_acss AS PA
  INNER JOIN acss.grp_pfl AS GP
    ON GP.cd_pfl_acss = PA.cd_pfl_acss
  INNER JOIN acss.ctu_grp AS CG
    ON CG.cd_gr_acss = GP.cd_grp_acss
  WHERE CG.cd_ctu = ?
  ORDER BY PA.cd_tp_pfl_acss ASC;

# Busca dcr_ctu a partir da uri
[selectCtuByPath]
  SELECT SQL_CACHE *
  FROM intranet.dcr_ctu 
  WHERE cd_tp_ctu NOT IN (99, 199)
    AND (
      tx_url_ctu like '/$where'
      OR tx_url_ctu like 'http://%/$where'
      OR tx_url_ctu like 'https://%/$where'
    )
  ORDER BY tx_url_ctu asc;

# Busca dcr_ctu a partir da url
[selectCtuByUrl]
  SELECT SQL_CACHE *
  FROM intranet.dcr_ctu 
  WHERE cd_tp_ctu NOT IN (99, 199)
    AND (
      tx_url_ctu like 'http://$where'
      OR tx_url_ctu like 'https://$where'
    )
  ORDER BY tx_url_ctu asc;

# Busca dcr_ctu a partir do código cd_ctu
[selectCtuById]
  SELECT SQL_CACHE *
  FROM intranet.dcr_ctu 
  WHERE cd_ctu = 99999
  LIMIT 1;



{auth}

# Busca informações do Usuário no Banco de Dados
[selectUser]
  select u.CD_USU, 
      u.NM_USU,
      u.NM_ABVD,
      p.NR_TCEL,
      concat(u.CD_USU, ' ', u.NM_USU) as chaveNome,
      u.CD_CMSS,
      u.CD_IOR,
      d.CD_PILAR,
      p.TX_CMSS_FUN,
      p.NR_CPF,
      p.CD_EMAI_BB,
      p.CD_CLI,
      d.CD_PRF,
      (	select CD_PRF from mstNovo.depe 
        where CD_UOR = mstNovo.diretoria(u.CD_UOR_LCLZ)
      ) as prfDiretoria,
      e.SG_UF,
      p.CD_TEL_TRB,
      d.CD_TIP_UOR,
      u.CD_UOR_LCLZ,
      u.CD_UOR_EQP
  from arhNovo.tb_usu as u
  left join arh.dado_pss as p
    on p.CD_USU = u.CD_USU
  inner join mstNovo.depe as d
    on d.CD_UOR = u.CD_UOR_LCLZ
  left join mstNovo.depe_end as e
    on e.CD_UOR = d.CD_UOR
  where u.CD_USU = ?
  limit 1;
